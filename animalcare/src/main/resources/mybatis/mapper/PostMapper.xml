<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="usyd.mingyi.animalcare.mapper.PostMapper">
     <insert id="addPost" parameterType="Post" useGeneratedKeys="true" keyProperty="postId" keyColumn="post_id">
         insert into post (post_id,post_user_id,post_content,post_time,tag,topic)
          values (#{postId},#{userId},#{postContent},#{posTime},#{tag},#{topic})
     </insert>



    <insert id="addImage">
        insert into image(image_post_id,image_url)values (#{imagePostId},#{imageUrl})
    </insert>

    <select id="getAllPosts" resultMap="postInfos">
        select *,(SELECT COUNT(*) FROM post)AS total from post AS po left join image AS i on po.post_id=i.image_post_id
        left join user As u on po.post_user_id=u.id
        limit #{currPage} , #{pageSize}
    </select>

    <resultMap id="postInfos" type="Post">
        <result property="postId" column="post_id"/>
        <result property="userId" column="post_user_id"/>
        <result property="love" column="love"/>
        <result property="postContent" column="post_content"/>
        <result property="topic" column="topic"/>
        <result property="posTime" column="post_time"/>
        <result property="tag" column="tag"/>
        <result property="userAvatar" column="user_image_address"/>
        <result property="totalPosts" column="total"/>
        <collection property="imageUrlList" ofType="String">
            <result column="image_url"/>
        </collection>
    </resultMap>

    <select id="queryPostById" resultMap="postInfo">
        select * from post AS po left join image AS i on po.post_id=i.image_post_id
                                 left join user As u on po.post_user_id=u.id
        where po.post_id=#{postId}
    </select>



    <resultMap id="postInfo" type="Post">
        <result property="postId" column="post_id"/>
        <result property="userId" column="post_user_id"/>
        <result property="love" column="love"/>
        <result property="postContent" column="post_content"/>
        <result property="topic" column="topic"/>
        <result property="posTime" column="post_time"/>
        <result property="tag" column="tag"/>
        <result property="userAvatar" column="user_image_address"/>
        <result property="nickName" column="nickname"/>
        <result property="userName" column="username"/>
        <collection property="imageUrlList" ofType="String">
            <result column="image_url"/>
        </collection>
    </resultMap>

    <select id="checkLoved" resultType="java.lang.Boolean">
       select count(*) from userlove where post_id = #{postId} and user_id = #{userId}
    </select>
    
    <update id="lovePlus">
        update post set love=love+1 where post_id = #{postId}
    </update>
    <update id="loveMinus">
        update post set love=love-1 where post_id = #{postId}
    </update>

    <insert id="love">
        insert into userlove(post_id,user_id)values (#{postId},#{userId})
    </insert>

    <delete id="cancelLove">
        delete from userlove where post_id=#{postId} and user_id=#{userId}
    </delete>

    <delete id="deletePost" parameterType="int">
        delete from post where post_id = #{postId}
    </delete>

    <insert id="addComment" parameterType="int">
        insert into comment(comment_id, comment_post_id, comment_time, comment_content)
        values(#{id},#{postId},#{commentTime},#{commentContent})
    </insert>


</mapper>